<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Constellation of Us</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        body, html { margin: 0; padding: 0; overflow: hidden; background-color: #000; cursor: default; }
        canvas { display: block; }
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease, visibility 0.5s ease;
            z-index: 1000;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            max-width: 90vw;
            max-height: 90vh;
            animation: modal-fade-in 0.7s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes modal-fade-in {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal img {
            max-width: 60vh;
            max-height: 60vh;
            border-radius: 1rem;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
            object-fit: contain;
        }
        .modal-text {
            color: #f0f0f0;
            font-family: 'Lora', serif;
            font-size: clamp(1rem, 2.5vw, 1.5rem);
            line-height: 1.7;
            max-width: 600px;
            font-style: italic;
        }
        .initial-message {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: 'Lora', serif;
            font-size: 1.5rem;
            text-align: center;
            z-index: 10;
            opacity: 1;
            transition: opacity 1s ease 2s;
            pointer-events: none;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
</head>
<body>
    <canvas id="starfield"></canvas>
    <div id="initial-message">Click the brightest star.</div>
    <div id="modal" class="modal">
        <div class="modal-content">
            <img id="modal-image" src="" alt="Memory">
            <p id="modal-text"></p>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let stars = [];
        let mouse = { x: undefined, y: undefined };
        let audioStarted = false;

        const memories = [
            { id: 0, x: 0.5, y: 0.5, size: 20, isGolu: true, text: "They say a man's home is his castle. They're wrong. A man's home is his Queen. All of this... I'm building it for you.", image: 'IMG-20250627-WA0007.jpg', color: '#FFD700' },
            { id: 1, x: 0.25, y: 0.3, size: 10, text: "You thought the world saw flaws. I saw the girl who was strong enough to trust me with her fears. That trust is the most valuable thing I own.", image: 'IMG-20250627-WA0003.jpg', color: '#A7C7E7' },
            { id: 2, x: 0.75, y: 0.25, size: 10, text: "In a world of noise, you are the harmony. In this moment, the universe stopped just to admire us.", image: 'IMG-20250703-WA0002.jpg', color: '#F8C8DC' },
            { id: 3, x: 0.3, y: 0.7, size: 10, text: "A name whispered to a wooden bench, a secret kept safe. This is where the code began.", image: 'IMG-20250627-WA0005.jpg', color: '#B2FCE4' }
        ];

        let memoryOrbs = memories.map(mem => new MemoryOrb(
            mem.id, mem.x * canvas.width, mem.y * canvas.height, mem.size, mem.isGolu, mem.text, mem.image, mem.color
        ));

        const modal = document.getElementById('modal');
        const modalImage = document.getElementById('modal-image');
        const modalText = document.getElementById('modal-text');
        const initialMessage = document.getElementById('initial-message');

        const synth = new Tone.PolySynth(Tone.Synth, {
            oscillator: { type: "fatsine" },
            envelope: { attack: 0.5, decay: 0.1, sustain: 0.3, release: 2 },
            volume: -10
        }).toDestination();
        const reverb = new Tone.Reverb({ decay: 10, wet: 0.6 }).toDestination();
        synth.connect(reverb);
        const heartbeat = new Tone.MembraneSynth({
            pitchDecay: 0.01, octaves: 6, volume: -5,
            envelope: { attack: 0.001, decay: 0.5, sustain: 0 }
        }).toDestination();

        function playNote(note, duration) {
            if (!audioStarted) return;
            synth.triggerAttackRelease(note, duration);
        }

        function playHeartbeat() {
            if (!audioStarted) return;
            heartbeat.triggerAttackRelease("C1", "8n", Tone.now());
            heartbeat.triggerAttackRelease("C1", "8n", Tone.now() + 0.3);
        }
        
        function initAudio() {
            if (audioStarted) return;
            Tone.start();
            audioStarted = true;
            const loop = new Tone.Loop(time => {
                synth.triggerAttackRelease("C2", "2m", time);
                synth.triggerAttackRelease("G2", "2m", time + 2);
                synth.triggerAttackRelease("E2", "2m", time + 4);
            }, "6m").start(0);
            Tone.Transport.start();
            initialMessage.style.opacity = '0';
        }

        class Star {
            constructor(x, y, radius, color) {
                this.x = x; this.y = y; this.radius = radius; this.color = color;
                this.baseRadius = radius;
                this.dx = (Math.random() - 0.5) * 0.2; this.dy = (Math.random() - 0.5) * 0.2;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2, false);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
            update() {
                if (this.x + this.radius > canvas.width || this.x - this.radius < 0) this.dx = -this.dx;
                if (this.y + this.radius > canvas.height || this.y - this.radius < 0) this.dy = -this.dy;
                this.x += this.dx; this.y += this.dy;
                this.draw();
            }
        }

        function MemoryOrb(id, x, y, size, isGolu, text, image, color) {
            this.id = id; this.x = x; this.y = y; this.size = size; this.isGolu = isGolu;
            this.text = text; this.image = image; this.color = color;
            this.baseSize = size; this.angle = Math.random() * Math.PI * 2;
            this.isHovered = false; this.isActivated = isGolu;

            this.draw = function() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.isActivated ? this.color : 'rgba(255, 255, 255, 0.2)';
                ctx.fill();

                if (this.isActivated) {
                    ctx.save();
                    ctx.shadowBlur = this.isHovered ? 30 : 15;
                    ctx.shadowColor = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    ctx.restore();
                }
            }

            this.update = function(goluOrb) {
                this.isHovered = Math.hypot(mouse.x - this.x, mouse.y - this.y) < this.size;
                this.size = this.isHovered ? this.baseSize * 1.5 : this.baseSize;

                if (goluOrb.isActivated && !this.isGolu) {
                    ctx.beginPath();
                    ctx.moveTo(goluOrb.x, goluOrb.y);
                    ctx.lineTo(this.x, this.y);
                    ctx.strokeStyle = `rgba(255, 215, 0, 0.3)`;
                    ctx.stroke();
                }
                
                this.angle += 0.001;
                if (!this.isGolu) {
                    this.x += Math.cos(this.angle) * 0.1;
                    this.y += Math.sin(this.angle) * 0.1;
                }
                this.draw();
            }
        }
        
        function init() {
            stars = [];
            for (let i = 0; i < 400; i++) {
                let radius = Math.random() * 1.5;
                let x = Math.random() * canvas.width;
                let y = Math.random() * canvas.height;
                stars.push(new Star(x, y, radius, 'white'));
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            stars.forEach(star => star.update());

            const goluOrb = memoryOrbs.find(orb => orb.isGolu);
            memoryOrbs.forEach(orb => orb.update(goluOrb));
            canvas.style.cursor = memoryOrbs.some(o => o.isHovered && o.isActivated) ? 'pointer' : 'default';
        }
        
        init();
        animate();

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            init();
            memoryOrbs = memories.map(mem => new MemoryOrb(mem.id, mem.x * canvas.width, mem.y * canvas.height, mem.size, mem.isGolu, mem.text, mem.image, mem.color));
        });

        window.addEventListener('mousemove', (event) => {
            mouse.x = event.x;
            mouse.y = event.y;
        });

        canvas.addEventListener('click', (event) => {
            if (!audioStarted) initAudio();
            
            let clickedOrb = null;
            for (let i = memoryOrbs.length - 1; i >= 0; i--) {
                const orb = memoryOrbs[i];
                if (orb.isHovered && orb.isActivated) {
                    clickedOrb = orb;
                    break;
                }
            }

            if (clickedOrb) {
                if (clickedOrb.isGolu) {
                    const goluOrb = memoryOrbs.find(o => o.isGolu);
                    goluOrb.isActivated = true;
                    memoryOrbs.forEach(o => o.isActivated = true);
                    playNote("C4", "2n");
                }
                modalImage.src = clickedOrb.image;
                modalText.textContent = clickedOrb.text;
                modal.classList.add('visible');
                playNote(clickedOrb.isGolu ? "C5" : "E4", "1n");
                if (clickedOrb.id === 2) {
                   setTimeout(playHeartbeat, 500);
                }
            }
        });

        modal.addEventListener('click', () => {
            modal.classList.remove('visible');
        });
    </script>
</body>
</html>
